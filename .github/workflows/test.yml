name: CI test
on:
  push:
    branches-ignore:
      - 'main'

jobs:
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Ensure we can build
        run: pnpm run build
      
      - name: Run Tests
        run: pnpm run test

  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        working-directory: ./pyserver
        run: |
          python -m pip install --upgrade pip
          pip install wheel
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Lint with mypy
        working-directory: ./pyserver
        run: |
          mypy . --explicit-package-bases
      
      - name: Test with pytest
        working-directory: ./pyserver
        run: |
          pip install pytest pytest-cov
          pytest --ignore=docs_src/ --cov=./

  docker-integration-tests:
    name: Docker Integration & Playwright Tests
    runs-on: ubuntu-latest
    env:
      ALLOWED_ORIGINS: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build Docker image
        run: |
          docker build -t trilogy-studio:test .
      
      - name: Run Docker container with health check
        run: |
          # Start container in detached mode
          CONTAINER_ID=$(docker run -d -p 8081:80 trilogy-studio:test)
          echo "CONTAINER_ID=$CONTAINER_ID" >> $GITHUB_ENV
          echo "Started container: $CONTAINER_ID"
      
      - name: Wait for container to be healthy
        run: |
          echo "Waiting for container to become healthy..."
          timeout 180 bash -c '
            while true; do
              HEALTH_STATUS=$(docker inspect --format="{{.State.Health.Status}}" $CONTAINER_ID)
              echo "Current health status: $HEALTH_STATUS"
              
              if [ "$HEALTH_STATUS" = "healthy" ]; then
                echo "✅ Container is healthy!"
                break
              elif [ "$HEALTH_STATUS" = "unhealthy" ]; then
                echo "❌ Container is unhealthy!"
                docker logs $CONTAINER_ID
                exit 1
              else
                echo "⏳ Waiting for health check... (status: $HEALTH_STATUS)"
                sleep 5
              fi
            done
          '
      
      - name: Test Docker endpoints
        run: |
          echo "Testing frontend (nginx)..."
          curl -f http://localhost:8081/ || (echo "Frontend health check failed" && exit 1)
          
          echo "Testing backend health endpoint..."
          curl -f http://localhost:8081/health || echo "Backend health endpoint not accessible"
          
          echo "✅ Docker container health checks passed!"
      
      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps
      
      - name: Run Playwright tests against Docker
        run: pnpm exec playwright test
        env:
          PLAYWRIGHT_USE_PREVIEW: 'true'
          TEST_ENV: 'docker'
          BASE_URL: 'http://localhost:8081'
      
      - name: Stop and remove Docker container
        if: always()
        run: |
          if [[ -n "$CONTAINER_ID" ]]; then
            echo "Stopping container: $CONTAINER_ID"
            docker stop $CONTAINER_ID || true
            docker rm $CONTAINER_ID || true
          fi
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-docker
          path: playwright-report/
          retention-days: 30

  playwright-local:
    name: Playwright Tests (Local)
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    env:
      VITE_RESOLVER_URL: http://127.0.0.1:5678
      ALLOWED_ORIGINS: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Install Python dependencies
        working-directory: ./pyserver
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Backend Python in background
        working-directory: ./pyserver
        run: |
          nohup python main.py > server.log 2>&1 &
          echo "SERVER_PID=$!" >> $GITHUB_ENV
          echo "Started server with PID: $SERVER_PID"
          sleep 10  
          
          if ps -p $(echo $SERVER_PID) > /dev/null; then
            echo "Server started successfully!"
          else
            echo "Failed to start server. Showing logs:"
            cat server.log
            exit 1
          fi
        shell: /usr/bin/bash -e {0}
      
      - name: Install Playwright Browsers
        run: pnpm exec playwright install --with-deps
      
      - name: Run Playwright tests (Local)
        run: pnpm exec playwright test
        env:
          PLAYWRIGHT_USE_PREVIEW: 'true'
          TEST_ENV: 'local'
      
      - name: Stop Python server
        if: always()
        run: |
          if [[ -n "$SERVER_PID" ]]; then
            echo "Stopping server with PID $SERVER_PID"
            kill $SERVER_PID || true
          fi
      
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-local
          path: playwright-report/
          retention-days: 30